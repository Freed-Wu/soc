<!-- markdownlint-disable MD024 -->

# 搭载板图像加速处理软件与中心机的串口传输协议

## 概述

搭载板图像加速处理软件与中心机之间的通信通过 RS422 串口实现：

- 中心机向搭载板传输 3840x2160 的图像数据，图像格式为 YUV422
- 搭载板向中心机输出二进制熵编码码流

```plantuml
中心机 <- 搭载板: 请求 YUV422 图片
中心机 -> 搭载板: 发送 YUV422 图片
中心机 -> 搭载板: 请求码流
中心机 <- 搭载板: 发送码流 (CRC 错误)
中心机 -> 搭载板: 请求码流
中心机 <- 搭载板: 发送码流
```

## 通信格式

搭载板以串行异步通信接口接收中心机发送的控制指令、数据输入，向中心机返回应答指令，发送数据。

- 接口电平： RS422
- 数据速率： 115.2 Kbps

通信方式采用标准串行协议；通信的基本单位为字符，每个字符传输时为 11 位（ 1 位起始 + 8 位数据 + 1 位奇校验 + 1 位停止），其中数据位传输字节内先传低位（D0），最后传高位（D7），参考
[Serial Programming Guide for POSIX Operating Systems](http://mathdesc.fr/documents/serial/serial.html)：

![async](http://mathdesc.fr/documents/serial/serial_fichiers/async.gif)

多字节数据传送：先传送最高字节数据，然后传送次高字节数据，最后传送最低字节数据。

## 帧格式

采用定长帧。具体一帧的格式如下表所示。

- 表中一字节为 8 bit
- 每个域的高字节在前，低字节在后；字节内高位 B7 在前，低位 B0 在后。例如：帧计数 3 个字节，先输出最高字节，最后输出最低字节

### 数据传输格式

| 字节序号        | 名称     | 字节  | 定义或处理方法       | 备注                          |
| ----------- | ------ | --- | ------------- | --------------------------- |
| 1-4         | 帧头     | 4   | 0xEB90EB90    |                             |
| 5-6         | 发送地址   | 2   | 主机 00H/从机 01H |                             |
| 7-8         | 指令类型   | 2   | 数据传输 05H      |                             |
| 9-12        | 数据文件编号 | 4   | 0x00000001    | 第几张图片                       |
| 13-14       | 帧序号    | 2   | 0x0001-0xFFFF |                             |
| 15-(16+512) | 数据     | 514 |               | 前 2 个字节为有效压缩数据，不足 512 字节的补零 |
| 529-530     | CRC 校验 | 2   |               | CRC-16/MODBUS               |

### 请求数据命令格式

| 序号    | 描述     | 字节  | 定义或处理方法       | 备注            |
| ----- | ------ | --- | ------------- | ------------- |
| 1-4   | 帧头     | 4   | 0xEB90EB90    |               |
| 5-6   | 发送地址   | 2   | 主机 00H/从机 01H |               |
| 7-8   | 指令类型   | 2   | 数据请求 03H      |               |
| 9-12  | 数据文件编号 | 4   | 0x00000001    |               |
| 13-14 | 帧序号    | 2   | 0x0001-0xFFFF |               |
| 15-16 | CRC 校验 | 2   |               | CRC-16/MODBUS |

### 控制命令格式

| 序号    | 描述     | 字节  | 定义或处理方法       | 备注            |
| ----- | ------ | --- | ------------- | ------------- |
| 1-4   | 帧头     | 4   | 0xEB90EB90    |               |
| 5-6   | 发送地址   | 2   | 主机 00H/从机 01H |               |
| 7-8   | 指令类型   | 2   | 控制 01H        |               |
| 9-12  | 命令编号   | 4   | 未定义           | 没有数据文件编号      |
| 13-14 | 帧序号    | 2   | 0x0001-0xFFFF |               |
| 15-16 | CRC 校验 | 2   |               | CRC-16/MODBUS |
